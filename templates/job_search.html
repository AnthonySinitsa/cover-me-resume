{% extends 'base.html' %}

{% block extra_css %}
<style>
    .loader {
        border: 16px solid #f3f3f3; 
        border-top: 16px solid #3498db; 
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
        margin: 20px auto;
        display: none;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<h2>Start Job Scraper</h2>

<form method="post" action="{% url 'job_search' %}" id="jobSearchForm">
    {% csrf_token %}
    <div>
        <label for="job_title">Job Title:</label>
        <input type="text" name="job_title" required>
    </div>
    
    <div>
        <label for="location">Location:</label>
        <input type="text" name="location" required>
    </div>
    
    <div>
        <button type="button" onclick="submitFormAndStartLoading()">Start Scraping</button>
    </div>
</form>

<div class="loader" id="loadingSpinner"></div>
{% endblock %}

{% block extra_js %}
<script>
    function submitFormAndStartLoading() {
        document.getElementById('jobSearchForm').submit();
        document.getElementById('loadingSpinner').style.display = 'block';
        
        // Start checking the task status after a few seconds
        setTimeout(checkTaskStatus, 5000);
    }

    function checkTaskStatus() {
        fetch('/task_status/{{ task_id }}/')
        .then(response => response.json())
        .then(data => {
            if (data.status === "SUCCESS" || data.status === "FAILURE") {
                // If the task is done, redirect to the results page
                window.location.href = '/job-results/{{ task_id }}/';
            } else {
                // If the task is still running, check again after a few seconds
                setTimeout(checkTaskStatus, 5000);
            }
        });
    }
</script>
{% endblock %}
